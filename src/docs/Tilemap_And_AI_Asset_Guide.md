# 瓦片地图渲染系统设计与 AI 素材生成指南

## 1. 系统概述
本设计旨在将《东方异世界居酒屋》的地图渲染层从原始的 Canvas 几何填充（`fillRect`）升级为基于**瓦片集（Tileset）**的专业 2D 像素渲染系统。
通过引入 **Sprite Sheet（精灵表单）** 技术和 **Auto-tiling（自动图块拼接）** 算法，结合 AI 生成的高质量美术素材，大幅提升游戏的视觉表现力。

---

## 2. AI 素材生成工作流 (AI Asset Pipeline)

### 2.1 核心理念：网格切分法 (Grid Slicing)
利用多模态大模型（如 Gemini 3 Pro）强大的图像生成能力，一次性生成包含多个变体的“整合图”，然后通过程序按固定比例切分。
*   **输入**：自然语言提示词，要求 AI 输出 3x3 或 4x3 的网格布局图像。
*   **输出**：一张高分辨率（如 1:1 方图）的图片，包含 9 个或 12 个独立的纹理块。
*   **处理**：游戏引擎读取该图片，按网格切割成独立的 `ImageBitmap` 对象。

### 2.2 Gemini 3 Pro 提示词指南 (Prompt Guide)

以下是经过优化的自然语言提示词模板，专为生成易于切分的“九宫格”素材设计。你可以直接复制给 AI 使用。

#### **参考图生成模式：地面 (Floor - Seamless Tiling)**
此模式用于生成居酒屋室内大面积铺设的木质地板。核心要求是生成的瓦片必须支持**四向（上下左右）完全无缝平铺**。

> **Prompt:**
> 你现在是一位资深的像素艺术家。请基于我提供的**参考图**，生成一张**居酒屋室内地板（Izakaya Floor）**的 2x2 瓦片集。
>
> **1. 核心任务：**
> *   **四向无缝平铺 (Seamless Tiling)**：这是最重要的任务。生成的 4 个瓦片（2x2）必须能以任意顺序在水平和垂直方向上无限重复，且没有任何可见的接缝或断裂。
> *   **材质一致性**：风格、色调、木纹粗细必须完全统一。
>
> **2. 约束（Critical Constraints）：**
> *   **边缘对齐 (Edge Matching)**：
>     *   **左右对齐**：任何瓦片的左边缘像素排列必须与任何瓦片的右边缘完全匹配。
>     *   **上下对齐**：任何瓦片的顶边缘像素排列必须与任何瓦片的底边缘完全匹配。
> *   **低视觉频率 (Low Visual Frequency)**：严禁出现过于显眼的木结、裂纹或颜色突变。如果某个特征太显眼，在大面积平铺时会形成烦人的“重复斑点感”。
> *   **平光风格**：无阴影，无高光，仅保留木材本身的纹理和色调。
>
> **3. 布局要求（2x2 瓦片集）：**
> *   **Top-Left (0,0)**: 标准主瓦片。
> *   **Top-Right (0,1)**: 细微变体 A（改变 5%-10% 的内部木纹，保持边缘不变）。
> *   **Bottom-Left (1,0)**: 细微变体 B（改变 5%-10% 的内部木纹，保持边缘不变）。
> *   **Bottom-Right (1,1)**: 细微变体 C（改变 5%-10% 的内部木纹，保持边缘不变）。
>
> **输出要求**：
> *   输出一张包含 4 个（2x2）瓦片的正方形图片。
> *   **严禁出现任何边框线条**。
> *   确保图片的四周边缘（整张大图的上下左右）也可以互相衔接，实现全图的 Seamless 循环。

---

#### **进阶：结构化物件（如吧台/长桌） (3x3 Nine-Slice)**
对于吧台、地毯或大型长桌，不能只生成一张图。我们需要一套“九宫格”切片来处理横向、纵向延伸以及拐角。

> **Prompt:**
> 你现在是一位资深的像素艺术家。请生成一张用于游戏吧台（Counter）或长桌的 3x3 瓦片集。
>
> **1. 约束：**
> *   **风格**：日式深色木质，精细像素，正俯视视角。
> *   **完全平光（Flat Lighting）**：**严禁**绘制任何方向性光源或投射阴影。仅保留表现物体体积感所必须的最基础的“自阴影”（Self-shadowing，如桌子边缘的厚度暗面），不要有外部光照影响。
> *   **严格统一**：九个格子必须能无缝拼接，木纹走向和边缘阴影必须逻辑一致。
>
> **2. 构图逻辑（3x3 九宫格）：**
> *   **（左上）**：吧台的左上拐角。
> *   **（中上）**：吧台的水平中段（上边缘）。
> *   **（右上）**：吧台的右上拐角。
> *   **（左中）**：吧台的垂直中段（左边缘）。
> *   **（正中）**：吧台的纯桌面填充（四面无边，用于大面积铺设）。
> *   **（右中）**：吧台的垂直中段（右边缘）。
> *   **（左下）**：吧台的左下拐角。
> *   **（中下）**：吧台的水平中段（下边缘）。
> *   **（右下）**：吧台的右下拐角。
>
> **输出要求**：确保每一格的边缘在拼接时能够完美对齐，没有明显的接缝。

#### **参考图生成模式：结构性组件 - 墙体 (Chroma Key Wall)**
此模式生成的墙体应使用**纯绿幕（#00FF00）**作为背景。**解决接缝策略：要求生成连续的纹理长条，并严格区分垂直与水平纹理。**

> **Prompt:**
> 你现在是一位资深的像素艺术家。请基于我提供的**参考图**，生成一张 3x3 的**居酒屋墙体（Izakaya Wall）**。
>
> **1. 核心任务：**
> *   **连续纹理块 (Continuous Block)**：不要把 9 个瓦片分开画。请画出一面**完整的、连续的墙**。
> *   **纹理导向 (Texture Orientation)**：
>     *   **墙面 (Wall Body)**：必须呈现**明显的垂直走向**。如果是木质，请使用垂直的木纹、木条或立柱；如果是石质，请确保缝隙或纹理暗示了高度。
>     *   **墙顶 (Wall Top)**：必须呈现**水平平面感**，表现出墙体的厚度。
> *   **背景填充**：仅在墙体轮廓之外使用 **#00FF00**。墙体内部严禁出现任何背景色像素。
>
> **2. 布局要求（严格遵循 3x3 九宫格）：**
> *   **Row 1 (Wall Top)**：墙顶部分，表现厚度的水平面纹理。
>     *   (1,1) 左上拐角 | (1,2) 墙顶中段 | (1,3) 右上拐角
> *   **Row 2 (Wall Body)**：核心垂直墙身，垂直木纹或立柱。
>     *   (2,1) 左边缘柱 | (2,2) 纯墙面中心 | (2,3) 右边缘柱
> *   **Row 3 (Wall Base)**：踢脚线或墙基。
>     *   (3,1) 左下拐角 | (3,2) 墙基中段 | (3,3) 右下拐角
>
> **3. 约束（Critical Constraints）：**
> *   **强化垂直感**：在 Row 2（墙身）部分，每隔一段距离可以画一个垂直的支撑木柱或线条，以在视觉上引导高度感。
> *   **消除分割感**：严禁在瓦片之间绘制任何线条、阴影缝隙或绿幕像素。墙面必须像是一块整木切出来的。
> *   **边缘溢出 (Bleeding)**：让墙体的纹理稍微“溢出”到相邻瓦片的边界，确保切分时边缘是饱满的纹理。
>
> **输出要求**：
> *   **绝对零间距**：图像内部不准有任何非墙体的像素。
> *   背景颜色：#00FF00。

---

#### **参考图生成模式：结构性组件 - 吧台 (Chroma Key Counter)**
此模式生成的吧台要求**绝对连续性**。**解决接缝策略：要求 AI 将其视为一个单一的几何实体，而非 9 个独立的块。**

> **Prompt:**
> 你现在是一位资深的像素艺术家。请基于我提供的**参考图**，生成一张 3x3 的**居酒屋吧台（Izakaya Counter）**。
>
> **1. 核心任务：**
> *   **连续纹理块 (Continuous Block)**：严禁在 3x3 的网格线上绘制任何分割线、间隙或绿幕像素。请画出一个**完整的、实心的、无缝的**吧台。
> *   **视觉结构**：
>     *   **台面 (Tabletop)**：呈现平滑的、水平走向的木纹。
>     *   **立面 (Facade)**：呈现垂直的木板纹理或支撑结构。
> *   **背景填充**：仅在吧台的**外轮廓**之外使用 **#00FF00**。吧台内部的所有瓦片交界处必须被纹理完全填满。
>
> **2. 布局要求（严格遵循 3x3 九宫格）：**
> *   **Row 1 (Top Layer)**：吧台内侧/操作台。
>     *   (1,1) 左上拐角 | (1,2) 中间段 | (1,3) 右上拐角
> *   **Row 2 (Countertop Layer)**：核心水平台面。
>     *   (2,1) 左侧封边 | (2,2) 纯桌面中心 | (2,3) 右侧封边
> *   **Row 3 (Facade Layer)**：吧台垂直立面。
>     *   (3,1) 左下拐角 | (3,2) 正立面中段 | (3,3) 右下拐角
>
> **3. 约束（Critical Constraints）：**
> *   **消除网格感**：吧台的纹理（如木纹）必须横跨瓦片边界自然延伸，看起来像是一整块大木头切割而成的。
> *   **边缘溢出 (Bleeding)**：让吧台的边缘纹理稍微“溢出”到相邻瓦片的边界，确保切分时不会出现绿色的边缘线。
> *   **视角**：45度俯视，确保与墙体透视一致。
>
> **输出要求**：
> *   **绝对零间距**：吧台内部严禁出现任何绿色像素。
> *   背景颜色：#00FF00。

#### **参考图生成模式：用餐区专项 - 椅子 (Chroma Key Chairs)**
此模式用于生成带有四个朝向的椅子。

> **Prompt:**
> 你现在是一位资深的像素艺术家。请生成一张**居酒屋椅子（Izakaya Chair）**的 Sprite Sheet，背景为纯绿色（#00FF00）。
>
> **1. 布局要求（严格遵循 2x2 网格）：**
> *   **(1,1)**：椅子朝**下** (背向玩家)。
> *   **(1,2)**：椅子朝**上** (面向玩家)。
> *   **(2,1)**：椅子朝**左** (侧面)。
> *   **(2,2)**：椅子朝**右** (侧面)。
>
> **2. 约束（重要 - 尺寸与构图）：**
> *   **饱满构图 (Full Frame)**：椅子必须充满整个单元格。主体应占据单元格 90% 以上的面积，避免周围出现过多绿幕空白。
> *   **视角**：Top-down perspective (45度俯视)。
> *   **风格**：日式木质，无投射阴影。
> *   **背景**：#00FF00。
>
> ---
>
> #### **参考图生成模式：用餐区专项 - 桌子 (Chroma Key Tables)**
此模式用于生成横向与纵向的桌子及其变体。

> **Prompt:**
> 你现在是一位资深的像素艺术家。请生成一张**居酒屋长桌（Izakaya Table）**的 Sprite Sheet，背景为纯绿色（#00FF00）。
>
> **1. 布局要求（严格遵循 2x2 网格）：**
> *   **(1,1)**：**纵向标准桌** (垂直走向，表现侧边厚度，无装饰)。
> *   **(1,2)**：**纵向变体桌** (垂直走向，桌面上放有酒杯、筷子或有磨损痕迹)。
> *   **(2,1)**：**横向标准桌** (水平走向，表现长条纹理，无装饰)。
> *   **(2,2)**：**横向变体桌** (水平走向，桌面上铺有桌布或放有小菜盘)。
>
> **2. 约束（重要 - 尺寸与构图）：**
> *   **最大化填充 (Maximum Fill)**：长桌在网格内必须极其饱满。纵向桌应紧贴上下边界，横向桌应紧贴左右边界。物件主体应占据其所在网格 95% 以上的面积。
> *   **视角**：Top-down perspective (45度俯视)，确保与墙体透视一致。
> *   **一致性**：横向与纵向桌子的木材颜色 and 材质质感必须完全统一。
> *   **无投影**：不要绘制投射在地面的阴影。
> *   **背景**：#00FF00。
>
> ---
>
> #### **参考图生成模式：装饰性杂项 (Chroma Key Props)**
> 生成居酒屋内的各类装饰小物件。
>
> **Prompt:**
> 你现在是一位资深的像素艺术家。请生成一套**居酒屋装饰摆件（Props）**的 Sprite Sheet。
>
> **1. 核心任务：**
> *   生成一张包含 12 个独立物件的 Sprite Sheet，背景统一使用**纯绿色（#00FF00）**。
>
> **2. 布局要求（严格遵循 3行4列 3x4 网格）：**
> *   **朝向说明 (Orientation)**：除了灯笼等无方向性物件外，所有具有正面特征的物件（如招财猫、挂轴、碗碟堆、置物桌）必须**统一朝向正下方（面向玩家/正前方）**。
> *   **Row 1 (厨房杂项)**：
>     1. **洗碗槽** (正面透视，带水槽纹理)
>     2. **厨灶与锅** (正面朝向)
>     3. **碗碟堆** (正面堆叠，展示瓷碗花纹)
>     4. **调料架** (正面摆放，露出酒瓶标签)
> *   **Row 2 (氛围装饰)**：
>     1. **室内灯笼** (中心对称)
>     2. **招财猫** (正面朝向玩家)
>     3. **盆栽** (正面朝向)
>     4. **储物箱/书架** (正面开口朝向玩家)
> *   **Row 3 (生活细节)**：
>     1. **酒桶** (正面展示酒标)
>     2. **挂轴** (正面展示书法)
>     3. **屏风** (正面展开)
>     4. **厨房置物桌** (正面朝向玩家，展示侧面抽屉或纹理细节)

**3. 约束（重要 - 尺寸与构图）：**
> *   **高填充率 (High Fill Rate)**：每个物件在 48x48 的格子里必须占据 **85%-95%** 的空间。严禁生成过小的物件。物件的边缘应紧贴网格边界，仅预留 1-2 像素的极窄边距。
> *   **视角**：45度俯视，无投射阴影。
> *   **背景**：#00FF00。
> *   **风格**：粗线条、色彩明快的像素风，确保在游戏内清晰可见。
>
> **输出要求**：
> *   输出一张包含 4x3 布局装饰物的 Sprite Sheet，背景为纯绿色。
> *   **严禁出现任何格线**，确保物件主体足够庞大，充满整个单元格。

---

## 3. 核心技术方案 (Technical Solution)

### 3.1 数据结构升级
*   **`TileSet` 接口**：
    ```typescript
    interface TileSet {
        image: HTMLImageElement; // 原始大图
        gridSize: number;        // 网格大小（如 48px）
        variants: {
            [key: string]: { row: number, col: number }[] // 例如 'floor': [{0,0}, {0,1}, {0,2}]
        };
    }
    ```

### 3.2 渲染管线改造 (`IzakayaScene.ts`)
1.  **加载阶段**：
    *   引入 `TileLoader`，加载图片并根据配置切割成缓存的 Canvas 或坐标映射。
2.  **绘制阶段 (`draw`)**：
    *   **Layer 0 (地板)**：遍历地图，根据坐标 `(x, y)` 生成伪随机索引，从 `variants['floor']` 中选取一个切片绘制。
    *   **Layer 1 (墙壁/物体)**：
        *   使用 **Bitmasking** 算法计算墙壁的邻接状态（0-15 或 0-47）。
        *   根据状态值选择对应的墙壁切片。
        *   按 Y 坐标排序绘制物体（Y-Sort），确保遮挡关系正确。

### 3.3 随机变体算法 (Random Variation)
为了消除重复感，不使用真正的随机数（避免每帧闪烁），而是使用基于坐标的哈希函数：
```typescript
function getVariantIndex(x: number, y: number, count: number): number {
    // 简单的伪随机哈希
    return Math.abs((x * 37 + y * 17) ^ (x * y)) % count;
}
```

### 3.4 绿幕边缘处理 (Chroma Key Edge Correction)
由于 AI 生成的素材在绿幕边缘可能存在 1-2 像素的色彩污染或抗锯齿绿边，渲染引擎在切分素材时采用了 **Inner Bleed（边缘收缩）** 技术：
*   **原理**：在切分 3x3 瓦片时，每个瓦片的采样区域会向中心收缩 `innerBleed` 个像素（当前默认配置为 2px）。
*   **代码实现**：已在 `TextureManager.ts` 的 `sliceImage` 方法中实现。
*   **优势**：强制剔除绿幕接缝，确保在连续铺设墙体或吧台时，视觉上完全无缝。

---

## 4. 下一步实施规划 (Roadmap)

1.  **素材准备 (User)**：
    *   使用上述 Prompt 生成 1-2 张测试用的 Sprite Sheet（一张地板/墙壁，一张家具）。
    *   将图片放入 `src/assets/tilesets/` 目录。

2.  **引擎改造 (Dev)**：
    *   [ ] 创建 `TextureManager.ts` 用于管理图片加载与切分。
    *   [ ] 修改 `IzakayaScene.ts`，替换 `ctx.fillRect` 为 `ctx.drawImage`。
    *   [ ] 实现基础的地板随机纹理渲染。

3.  **进阶功能 (Dev)**：
    *   [ ] 实现墙壁 Auto-tiling 逻辑。
    *   [ ] 实现 Y 轴动态遮挡排序。
